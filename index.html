# ==== SWIFT-TEC index.html ã‚’ä½œã£ã¦é–‹ãã‚¹ã‚¯ãƒªãƒ—ãƒˆ ====
# 1. ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ Windows PowerShell ã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã‚‹
# 2. Enter ã‚’æŠ¼ã™
# 3. è‡ªå‹•ã§ index.html ã‚’ç”Ÿæˆã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã

$folder = "C:\Users\ab243\tec_tool_globalgrid_f107_copy"
if (!(Test-Path $folder)) {
    New-Item -ItemType Directory -Path $folder | Out-Null
}

$path = Join-Path $folder "index.html"

$html = @'
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>SWIFT-TEC: Global Ionospheric TEC Forecast Tool</title>
<style>
body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 20px; background: #f7f7f7; }
h1 { font-size: 22px; margin-bottom: 4px; color: #004b8d; }
h2 { margin-top: 20px; font-size: 18px; color: #333; }
h3 { margin-top: 14px; font-size: 16px; color: #333; }
textarea { width: 100%; height: 220px; font-family: monospace; }
pre { background: #fdfdfd; padding: 8px; max-height: 400px; overflow: auto; white-space: pre; border: 1px solid #ddd; }
.box { border: 1px solid #ccc; padding: 10px 12px; margin-bottom: 16px; border-radius: 8px; background: #ffffff; box-shadow: 0 0 4px rgba(0,0,0,0.03); }
input { width: 150px; }
label { display:inline-block; width:120px; }
button { margin-top: 5px; padding: 4px 10px; cursor: pointer; border-radius:4px; border:1px solid #888; background:#fafafa; }
button:hover { background:#f0f0f0; }
small { color:#555; }
.sub { margin-bottom: 16px; color:#555; }
</style>
</head>
<body>
<h1>SWIFT-TEC</h1>
<div class="sub">Space Weather Integrated Forecast Tool for Global Ionospheric TEC</div>

<div class="box">
  <h2>â‘  TECãƒ‡ãƒ¼ã‚¿å…¥åŠ›ï¼ˆWorld0000_tec.txtï¼‰</h2>
  <p>
    <b>https://downloads.sws.bom.gov.au/data/Satellite/World0000_tec.txt</b><br>
    ã‚’é–‹ã„ã¦ã€å†…å®¹ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ï¼ˆBOMã®å…ƒãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚<br>
    ã‚³ãƒ¡ãƒ³ãƒˆè¡Œï¼ˆ#ï½ï¼‰ã‚‚å«ã‚ã¦å…¨éƒ¨è²¼ã£ã¦OKã§ã™ã€‚
  </p>
  <textarea id="tecInput" placeholder="World0000_tec.txt ã®ä¸­èº«ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘"></textarea>
</div>

<div class="box">
  <h2>â‘¡ 27-day Outlook ã® F10.7 / Ap ã‚’ã‚³ãƒ”ãƒš</h2>
  <p>
    NOAA ã® 27-day Space Weather Outlook Tableï¼ˆ27DO.txtï¼‰ã®ä¸­èº«ã‚’<br>
    ã“ã®æ ã«ãã®ã¾ã¾ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚
  </p>
  <textarea id="outlookInput" placeholder=":Product: 27-day Space Weather Outlook Table 27DO.txt
...
2025 Nov 10     175          18          5
2025 Nov 11     180          35          6
2025 Nov 12     180          25          6
..."></textarea>
  <button id="parseOutlook">ä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ 3æ—¥åˆ†ã® F10.7 / Ap ã‚’æŠ½å‡º</button>
  <pre id="outlookStatus">æœªè§£æ</pre>

  <h3>æŠ½å‡ºã•ã‚ŒãŸ F10.7 / Apï¼ˆç·¨é›†ã‚‚å¯ï¼‰</h3>
  <label>Day1 F10.7:</label><input id="f107_1" type="number" step="0.1"><br>
  <label>Day1 Ap:</label><input id="ap_1" type="number" step="1"><br>
  <label>Day2 F10.7:</label><input id="f107_2" type="number" step="0.1"><br>
  <label>Day2 Ap:</label><input id="ap_2" type="number" step="1"><br>
  <label>Day3 F10.7:</label><input id="f107_3" type="number" step="0.1"><br>
  <label>Day3 Ap:</label><input id="ap_3" type="number" step="1"><br>

  <small>
    â€» è¡Œã®æ•°å­—ã‹ã‚‰ã€ŒF10.7 ã¯ 50ã€œ400 ã®ç¯„å›²ã®å€¤ã€ã€ŒAp ã¯å³ã‹ã‚‰2ç•ªç›®ã®å€¤ã€ã¨ã—ã¦è‡ªå‹•æŠ½å‡ºã€‚<br>
    â€» ã†ã¾ãã„ã‹ãªã„ã¨ãã¯ã€ã“ã“ã¸æ‰‹å…¥åŠ›ã—ã¦ã‚‚OKã§ã™ã€‚
  </small>
</div>

<div class="box">
  <h2>â‘¢ Dst / X-ray & ãƒ¢ãƒ‡ãƒ«ä¿‚æ•°</h2>
  <p>Dst / X-ray ã¯3æ—¥é–“åŒã˜å€¤ã‚’ä½¿ã†ç°¡ç•¥ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚</p>
  <label>Dst [nT]:</label><input id="dst" type="number" step="1" value="-20"><br>
  <label>X-ray:</label><input id="xray" type="number" step="0.0000001" value="0.000001"><br>
  <hr>
  <small>ä¸‹ã®ä¿‚æ•°ã¯ã€Œå…ƒã®TECã‚¹ã‚±ãƒ¼ãƒ«ã‚’ç¶­æŒã—ã¤ã¤ã€1æ—¥ã§æ•°TECUå¤‰åŒ–ã™ã‚‹ã€ãã‚‰ã„ã«èª¿æ•´ã—ã¦ã‚ã‚Šã¾ã™ã€‚</small><br>
  <label>Î±:</label><input id="alpha" type="number" value="0"><br>
  <label>Î²_TEC:</label><input id="betaTec" type="number" value="1"><br>
  <label>Î²_F10.7:</label><input id="betaF" type="number" value="0.0005"><br>
  <label>Î²_Dst:</label><input id="betaDst" type="number" value="0.005"><br>
  <label>Î²_Ap:</label><input id="betaAp" type="number" value="0.01"><br>
  <label>Î²_Xray:</label><input id="betaX" type="number" value="1000"><br>
  <small>
    TEC<sub>forecast</sub>(t+Î”t)
    = Î± + Î²_TECÂ·TEC(t,lon,lat)
    + Î”tÂ·(Î²_FÂ·F10.7<sub>day*</sub> + Î²_DstÂ·Dst + Î²_ApÂ·Ap<sub>day*</sub> + Î²_XÂ·Xray)<br>
    â€» Î”t ã«ã‚ˆã£ã¦ Day1/2/3 ã®ã©ã‚Œã‚’ä½¿ã†ã‹è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆã€‚<br>
    â€» Î²_TEC = 1 ãªã®ã§ã€Î”t=0 ã®ã¨ãã¯å…ƒã®BOMãƒãƒƒãƒ—ã¨ã»ã¼åŒã˜TECã‚¹ã‚±ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚
  </small>
</div>

<div class="box">
  <h2>â‘£ Î”t ã‚’æŒ‡å®šã—ã¦ä¸–ç•Œ1åº¦æ ¼å­ã®äºˆå ±ã‚’å‡ºåŠ›</h2>
  <p>çµŒåº¦ -180ã€œ180 degï¼ˆ1åº¦åˆ»ã¿ï¼‰ãŒæ¨ªè»¸ã€ç·¯åº¦ 90ã€œ-90 degï¼ˆ1åº¦åˆ»ã¿ï¼‰ãŒç¸¦è»¸ã®è¡¨ã‚’å‡ºã—ã¾ã™ã€‚</p>
  <label>Î”t [h] (å…ˆ):</label><input id="dtHour" type="number" step="1" value="1"><br>
  <small>0ã€œ24h â†’ Day1 ã® F10.7/Ap, 24ã€œ48h â†’ Day2, 48ã€œ72h â†’ Day3ï¼ˆãã‚Œä»¥ä¸Šã‚‚Day3ã§å›ºå®šï¼‰</small><br>
  <button id="runGlobal">ä¸–ç•Œ1åº¦æ ¼å­ TEC äºˆå ±ã‚’è¨ˆç®—</button>

  <h3>ç°¡æ˜“æƒ…å ±</h3>
  <pre id="infoBox">ã“ã“ã«å…ƒã‚°ãƒªãƒƒãƒ‰ã‚„Î”tãªã©ã®æƒ…å ±ãŒå‡ºã¾ã™</pre>

  <h3>ä¸–ç•Œ1åº¦æ ¼å­ TEC äºˆå ±ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰</h3>
  <p>
    å…ˆé ­è¡Œï¼šæ¨ªæ–¹å‘ã®çµŒåº¦ï¼ˆ-180ã€œ180ï¼‰<br>
    2è¡Œç›®ä»¥é™ï¼šè¡Œé ­ãŒç·¯åº¦ï¼ˆ90,89,...,-90ï¼‰ã€ç¶šã„ã¦ãã®ç·¯åº¦ã§ã®å„çµŒåº¦ã® TEC äºˆå ±å€¤ [TECU]<br>
    â†’ å…¨éƒ¨é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ã€Excel ã«è²¼ã‚Šä»˜ã‘ã‚Œã°ãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚
  </p>
  <pre id="globalOutput">ã“ã“ã«è¡¨ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</pre>
  <button id="copyBtn">ğŸ“‹ ã“ã®è¡¨ã‚’ã‚³ãƒ”ãƒ¼</button>
</div>

<script>
// ---------- â‘¡ 27-day Outlook ã‹ã‚‰ F10.7/Ap ã‚’3æ—¥åˆ†æŠ½å‡º ----------
document.getElementById("parseOutlook").addEventListener("click", () => {
  const txt = document.getElementById("outlookInput").value;
  const status = document.getElementById("outlookStatus");

  if (!txt.trim()) {
    alert("ã¾ãš 27-day Outlook ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const lines = txt.split(/\r?\n/);
  const fList = [];
  const apList = [];

  for (const raw of lines) {
    let line = raw.trim();
    if (!line) continue;
    if (!/[0-9]/.test(line)) continue;  // æ•°å­—ãŒãªã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—

    line = line
      .replace(/\u3000/g, " ")
      .replace(/,/g, " ")
      .replace(/\t/g, " ");

    const parts = line.split(/\s+/);
    const nums = parts
      .map(x => parseFloat(x))
      .filter(v => !Number.isNaN(v));

    if (nums.length < 3) continue;

    const apCand = nums[nums.length - 2];
    const fCandidates = nums.filter(v => v >= 50 && v <= 400 && v !== apCand && v < 1900);
    if (!fCandidates.length) continue;
    const f107 = fCandidates[fCandidates.length - 1];
    const ap   = apCand;

    fList.push(f107);
    apList.push(ap);

    if (fList.length >= 3) break;
  }

  if (fList.length === 0) {
    status.textContent = "F10.7 / Ap ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
    status.style.color = "#cc0000";
    return;
  }

  const fIds = ["f107_1","f107_2","f107_3"];
  const aIds = ["ap_1","ap_2","ap_3"];
  for (let i = 0; i < 3; i++) {
    if (fList[i] != null) {
      document.getElementById(fIds[i]).value = fList[i];
      document.getElementById(aIds[i]).value = apList[i];
    }
  }

  status.textContent =
    "æŠ½å‡ºå®Œäº†: " +
    `Day1 F10.7=${fList[0] ?? "?"}, Ap=${apList[0] ?? "?"} / ` +
    `Day2 F10.7=${fList[1] ?? "?"}, Ap=${apList[1] ?? "?"} / ` +
    `Day3 F10.7=${fList[2] ?? "?"}, Ap=${apList[2] ?? "?"}`;
  status.style.color = "#008800";
});

// ---------- World0000_tec.txt ã‚’ã€Œæ ¼å­ã€ã¨ã—ã¦èª­ã‚€ï¼ˆé ‘ä¸ˆç‰ˆï¼‰ ----------
function parseBomTec(text) {
  const lines = text.split(/\r?\n/);

  let latMin, latMax, latStep, latN;
  let lonMin, lonMax, lonStep, lonN;

  // 1) ã¾ãšãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰èª­ã¿ã«è¡Œãï¼ˆã‹ãªã‚Šã‚†ã‚‹ã„æ­£è¦è¡¨ç¾ï¼‹å¤§æ–‡å­—å°æ–‡å­—ç„¡è¦–ï¼‰
  for (let raw of lines) {
    const line = raw.trim();
    const latMatch = line.match(/latitude[^0-9\-+]*([-0-9.]+)\s+([-0-9.]+)\s+([-0-9.]+)\s+(\d+)/i);
    if (latMatch) {
      latMin  = parseFloat(latMatch[1]);
      latMax  = parseFloat(latMatch[2]);
      latStep = parseFloat(latMatch[3]);
      latN    = parseInt(latMatch[4], 10);
    }
    const lonMatch = line.match(/longitude[^0-9\-+]*([-0-9.]+)\s+([-0-9.]+)\s+([-0-9.]+)\s+(\d+)/i);
    if (lonMatch) {
      lonMin  = parseFloat(lonMatch[1]);
      lonMax  = parseFloat(lonMatch[2]);
      lonStep = parseFloat(lonMatch[3]);
      lonN    = parseInt(lonMatch[4], 10);
    }
  }

  // 2) æ•°å€¤ã ã‘å…¨éƒ¨é›†ã‚ã‚‹ï¼ˆ#è¡Œã¨ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯é™¤å¤–ï¼‰
  const values = [];
  for (let raw of lines) {
    let line = raw;
    if (/^\s*#/.test(line)) continue;
    if (/latitude/i.test(line) || /longitude/i.test(line)) continue;
    line = line.replace(/\u3000/g, " ").replace(/,/g, " ").replace(/\t/g, " ");
    const nums = line.split(/\s+/)
      .map(x => parseFloat(x))
      .filter(v => !Number.isNaN(v));
    if (nums.length) values.push(...nums);
  }

  const total = values.length;
  if (total === 0) {
    throw new Error("TEC æ•°å€¤ãŒä¸€ã¤ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
  }

  // 3) ãƒ˜ãƒƒãƒ€ãƒ¼ã§ latN/lonN ãŒå–ã‚Œãªã‹ã£ãŸã‚‰ã€ç·æ•°ã‹ã‚‰æ¨å®šã™ã‚‹
  if (!latN || !lonN) {
    const candidateLats = [
      { n: 71, min: -87.5, step: 2.5 },
      { n: 73, min: -90.0, step: 2.5 },
      { n: 91, min: -90.0, step: 2.0 }
    ];

    let found = false;
    for (const cand of candidateLats) {
      if (total % cand.n === 0) {
        latN   = cand.n;
        latMin = cand.min;
        latStep = cand.step;
        lonN   = total / cand.n;
        lonMin = -180;
        lonStep = (360 / (lonN - 1)); // -180..180 ã®ç­‰é–“éš”ã¨ã¿ãªã™
        found = true;
        break;
      }
    }

    if (!found) {
      throw new Error("LATITUDE/LONGITUDE GRID æƒ…å ±ãŒèª­ã‚ãšã€å€¤ã®å€‹æ•°ã‹ã‚‰ã‚‚æ¨å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
    }
  }

  // 4) ç·¯åº¦ãƒ»çµŒåº¦é…åˆ—ã‚’ä½œæˆ
  const latGrid = [];
  for (let i = 0; i < latN; i++) {
    latGrid.push(latMin + i * latStep);
  }
  const lonGrid = [];
  for (let j = 0; j < lonN; j++) {
    lonGrid.push(lonMin + j * lonStep);
  }

  // 5) TEC 2æ¬¡å…ƒé…åˆ—ã«ä¸¦ã¹æ›¿ãˆï¼ˆè¡Œï¼ç·¯åº¦ã€åˆ—ï¼çµŒåº¦ï¼‰ã¨ã¿ãªã™
  if (values.length < latN * lonN) {
    console.warn("æœŸå¾…ã•ã‚Œã‚‹å€¤ã®æ•°ã‚ˆã‚Šå°‘ãªã„ã§ã™: ", values.length, " / ", latN * lonN);
  }

  const tec = [];
  let k = 0;
  for (let i = 0; i < latN; i++) {
    const row = [];
    for (let j = 0; j < lonN; j++) {
      row.push(values[k++]);
    }
    tec.push(row);
  }

  return { latGrid, lonGrid, tec };
}

// ---------- å…ƒã®æ ¼å­ã‹ã‚‰ 1Â°Ã—1Â° ã«è£œé–“ã™ã‚‹é–¢æ•° ----------
function makeBilinear(src) {
  const { latGrid, lonGrid, tec } = src;
  const ny = latGrid.length;
  const nx = lonGrid.length;

  return function sample(lat0, lon0) {
    if (lat0 < latGrid[0]) lat0 = latGrid[0];
    if (lat0 > latGrid[ny - 1]) lat0 = latGrid[ny - 1];
    if (lon0 < lonGrid[0]) lon0 = lonGrid[0];
    if (lon0 > lonGrid[nx - 1]) lon0 = lonGrid[nx - 1];

    let iy1 = 0;
    for (let i = 0; i < ny - 1; i++) {
      if (latGrid[i] <= lat0 && lat0 <= latGrid[i + 1]) {
        iy1 = i;
        break;
      }
    }
    let ix1 = 0;
    for (let j = 0; j < nx - 1; j++) {
      if (lonGrid[j] <= lon0 && lon0 <= lonGrid[j + 1]) {
        ix1 = j;
        break;
      }
    }
    const iy2 = Math.min(iy1 + 1, ny - 1);
    const ix2 = Math.min(ix1 + 1, nx - 1);

    const y1 = latGrid[iy1], y2 = latGrid[iy2];
    const x1 = lonGrid[ix1], x2 = lonGrid[ix2];

    const f11 = tec[iy1][ix1];
    const f21 = tec[iy1][ix2];
    const f12 = tec[iy2][ix1];
    const f22 = tec[iy2][ix2];

    if ([f11,f21,f12,f22].some(v => Number.isNaN(v))) {
      let best = null, bestD2 = Infinity;
      for (let i = 0; i < ny; i++) {
        for (let j = 0; j < nx; j++) {
          const v = tec[i][j];
          if (Number.isNaN(v)) continue;
          const d2 = (latGrid[i] - lat0)**2 + (lonGrid[j] - lon0)**2;
          if (d2 < bestD2) { bestD2 = d2; best = v; }
        }
      }
      return best;
    }

    if (x2 === x1 || y2 === y1) return f11;

    const tx = (lon0 - x1) / (x2 - x1);
    const ty = (lat0 - y1) / (y2 - y1);

    const fxy =
      f11 * (1 - tx) * (1 - ty) +
      f21 * tx       * (1 - ty) +
      f12 * (1 - tx) * ty       +
      f22 * tx       * ty;

    return fxy;
  };
}

// ---------- Î”t ã«å¿œã˜ã¦ Day1/2/3 ã® F10.7/Ap ã‚’é¸æŠ ----------
function chooseDrivers(dtHour, f107_1,ap_1, f107_2,ap_2, f107_3,ap_3, dst,xray, betaF,betaDst,betaAp,betaX) {
  let fUsed = f107_1;
  let aUsed = ap_1;
  let dayLabel = "Day1 (0â€“24h)";

  if (dtHour > 24 && dtHour <= 48) {
    fUsed = f107_2;
    aUsed = ap_2;
    dayLabel = "Day2 (24â€“48h)";
  } else if (dtHour > 48) {
    fUsed = f107_3;
    aUsed = ap_3;
    dayLabel = "Day3 (48â€“72h, ãã‚Œä»¥ä¸Šã‚‚Day3ã‚’ä½¿ç”¨)";
  }

  const driver =
    betaF   * fUsed +
    betaDst * dst   +
    betaAp  * aUsed +
    betaX   * xray;

  return { driver, fUsed, aUsed, dayLabel };
}

// ---------- ã€Œä¸–ç•Œ1åº¦æ ¼å­ TEC äºˆå ±ã‚’è¨ˆç®—ã€ãƒœã‚¿ãƒ³ ----------
document.getElementById("runGlobal").addEventListener("click", () => {
  const tecText = document.getElementById("tecInput").value;
  if (!tecText.trim()) {
    alert("ã¾ãš World0000_tec.txt ã®ä¸­èº«ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  let src;
  try {
    src = parseBomTec(tecText);
  } catch (e) {
    console.error(e);
    alert("World0000_tec.txt ã®èª­ã¿å–ã‚Šã§ã‚¨ãƒ©ãƒ¼: " + e.message);
    return;
  }

  const bilinear = makeBilinear(src);

  const f107_1 = parseFloat(document.getElementById("f107_1").value);
  const ap_1   = parseFloat(document.getElementById("ap_1").value);
  const f107_2 = parseFloat(document.getElementById("f107_2").value);
  const ap_2   = parseFloat(document.getElementById("ap_2").value);
  const f107_3 = parseFloat(document.getElementById("f107_3").value);
  const ap_3   = parseFloat(document.getElementById("ap_3").value);

  const dst  = parseFloat(document.getElementById("dst").value);
  const xray = parseFloat(document.getElementById("xray").value);
  const alpha   = parseFloat(document.getElementById("alpha").value);
  const betaTec = parseFloat(document.getElementById("betaTec").value);
  const betaF   = parseFloat(document.getElementById("betaF").value);
  const betaDst = parseFloat(document.getElementById("betaDst").value);
  const betaAp  = parseFloat(document.getElementById("betaAp").value);
  const betaX   = parseFloat(document.getElementById("betaX").value);
  const dtHour  = parseFloat(document.getElementById("dtHour").value);

  const nums = [f107_1,ap_1,f107_2,ap_2,f107_3,ap_3,dst,xray,alpha,betaTec,betaF,betaDst,betaAp,betaX,dtHour];
  if (nums.some(v => Number.isNaN(v))) {
    alert("F10.7 / Ap / Dst / X-ray / ä¿‚æ•° / Î”t ã®ã©ã‚Œã‹ãŒä¸æ­£ã§ã™ã€‚");
    return;
  }

  const { driver, fUsed, aUsed, dayLabel } = chooseDrivers(
    dtHour, f107_1,ap_1, f107_2,ap_2, f107_3,ap_3,
    dst,xray, betaF,betaDst,betaAp,betaX
  );

  const infoLines = [];
  infoLines.push(`å…ƒã‚°ãƒªãƒƒãƒ‰: lat ${src.latGrid[0]}ï½${src.latGrid[src.latGrid.length-1]} (å…¨ ${src.latGrid.length} ç‚¹)`);
  infoLines.push(`           lon ${src.lonGrid[0]}ï½${src.lonGrid[src.lonGrid.length-1]} (å…¨ ${src.lonGrid.length} ç‚¹)`);
  infoLines.push(`Î”t = ${dtHour} [h], ä½¿ç”¨æ—¥: ${dayLabel}`);
  infoLines.push(`ä½¿ç”¨ F10.7=${fUsed}, Ap=${aUsed}, Dst=${dst}, X-ray=${xray}`);
  infoLines.push("");
  infoLines.push("â€» Î²_TEC = 1 ã®ãŸã‚ã€Î”t=0 ã®ã¨ãã¯å…ƒã®BOMãƒãƒƒãƒ—ã¨ã»ã¼åŒã˜TECã‚¹ã‚±ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚");
  document.getElementById("infoBox").textContent = infoLines.join("\n");

  const lines = [];
  const lonHeader = ["Lat/Lon"];
  for (let lon = -180; lon <= 180; lon++) lonHeader.push(String(lon));
  lines.push(lonHeader.join("\t"));

  for (let lat = 90; lat >= -90; lat--) {
    const row = [String(lat)];
    for (let lon = -180; lon <= 180; lon++) {
      const tec0 = bilinear(lat, lon);  // (lat, lon)
      const fcst = Number.isNaN(tec0)
        ? NaN
        : alpha + betaTec * tec0 + dtHour * driver;
      row.push(Number.isNaN(fcst) ? "NaN" : fcst.toFixed(3));
    }
    lines.push(row.join("\t"));
  }

  document.getElementById("globalOutput").textContent = lines.join("\n");
});

// ---------- ã‚³ãƒ”ãƒ¼ç”¨ãƒœã‚¿ãƒ³ ----------
document.getElementById("copyBtn").addEventListener("click", () => {
  const text = document.getElementById("globalOutput").textContent;
  if (!text.trim()) {
    alert("ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšäºˆå ±ã‚’è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert("âœ… TECäºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nExcelã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã§ãã¾ã™ã€‚");
    }).catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }

  function fallbackCopy(t) {
    const ta = document.createElement("textarea");
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand("copy");
      alert("âœ… TECäºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ï¼ˆæ—§æ–¹å¼ï¼‰");
    } catch (e) {
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦ æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
    }
    document.body.removeChild(ta);
  }
});
</script>
</body>
</html>
'@

Set-Content -Path $path -Value $html -Encoding UTF8
Write-Host "index.html ã‚’ä½œæˆãƒ»æ›´æ–°ã—ã¾ã—ãŸ: $path" -ForegroundColor Green
start $path
